# Garmin Connect é€£æºã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

MindBridge ã¯ `python-garminconnect` ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ Garmin Connect ã‹ã‚‰å¥åº·ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ Obsidian ãƒãƒ¼ãƒˆã¨ã—ã¦è‡ªå‹•ä¿å­˜ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚ OAuth ä¸è¦ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«ã‚ˆã‚Šã€ç¡çœ ã€æ­©æ•°ã€å¿ƒæ‹æ•°ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆçš„ã«ç®¡ç†ã§ãã¾ã™ã€‚

## æ©Ÿèƒ½ç‰¹å¾´

### ãƒ‡ãƒ¼ã‚¿å–å¾—
- **ç¡çœ ãƒ‡ãƒ¼ã‚¿**: ç¡çœ æ™‚é–“ã€æ·±ã„ç¡çœ ã€ãƒ¬ãƒ ç¡çœ ã€ç¡çœ ã‚¹ã‚³ã‚¢
- **æ­©æ•°ãƒ‡ãƒ¼ã‚¿**: æ—¥åˆ¥æ­©æ•°ã€ç›®æ¨™é”æˆç‡
- **å¿ƒæ‹æ•°ãƒ‡ãƒ¼ã‚¿**: å®‰é™æ™‚å¿ƒæ‹æ•°ã€æœ€å¤§å¿ƒæ‹æ•°ã€å¿ƒæ‹ã‚¾ãƒ¼ãƒ³
- **ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿**: é‹å‹•è¨˜éŒ²ã€ã‚«ãƒ­ãƒªãƒ¼æ¶ˆè²»ã€è·é›¢

### åˆ†ææ©Ÿèƒ½
- AI ã«ã‚ˆã‚‹å¥åº·ãƒ‡ãƒ¼ã‚¿å‚¾å‘åˆ†æ
- æ—¥åˆ¥ãƒ»é€±åˆ¥ãƒ»æœˆåˆ¥çµ±è¨ˆ
- ç•°å¸¸å€¤æ¤œå‡ºã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

### Obsidian çµ±åˆ
- `21_Health` ãƒ•ã‚©ãƒ«ãƒ€ã¸ã®è‡ªå‹•ä¿å­˜
- æ—¥æ¬¡å¥åº·ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä»˜ããƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### GarminClient (`src/garmin/client.py`)
```python
class GarminClient:
    # ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰
    authenticate()              # Garmin Connect èªè¨¼
    get_health_data()          # çµ±åˆãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—
    get_cache_stats()          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆ
    test_connection()          # æ¥ç¶šãƒ†ã‚¹ãƒˆ
```

**ä¸»è¦æ©Ÿèƒ½:**
- è‡ªå‹•èªè¨¼ãƒ»å†èªè¨¼
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 24 æ™‚é–“ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒªãƒˆãƒ©ã‚¤
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒã‚§ãƒƒã‚¯

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« (`src/garmin/models.py`)
```python
# ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
HealthData          # çµ±åˆå¥åº·ãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ SleepData      # ç¡çœ ãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ StepsData      # æ­©æ•°ãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ HeartRateData  # å¿ƒæ‹æ•°ãƒ‡ãƒ¼ã‚¿
â””â”€â”€ ActivityData   # ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿

# ã‚¨ãƒ©ãƒ¼å‹
GarminConnectionError      # æ¥ç¶šã‚¨ãƒ©ãƒ¼
GarminAuthenticationError  # èªè¨¼ã‚¨ãƒ©ãƒ¼
GarminDataRetrievalError  # ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼
GarminRateLimitError      # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼
GarminTimeoutError        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
GarminOfflineError        # ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹
```

#### ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿åˆ†æ (`src/health_analysis/analyzer.py`)
```python
class HealthDataAnalyzer:
    # AI ã‚’ä½¿ç”¨ã—ãŸå¥åº·ãƒ‡ãƒ¼ã‚¿åˆ†æ
    # ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã€ç•°å¸¸å€¤æ¤œå‡ºã€æ´å¯Ÿç”Ÿæˆ
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ  (`src/garmin/cache.py`)
- ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æœ€é©åŒ–
- API ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å›é¿
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®éå»ãƒ‡ãƒ¼ã‚¿åˆ©ç”¨

### ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ (`src/garmin/formatter.py`)
- Obsidian ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã¸ã®å¤‰æ›
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
- ã‚°ãƒ©ãƒ•ãƒ»ãƒãƒ£ãƒ¼ãƒˆå¯¾å¿œ

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ç’°å¢ƒå¤‰æ•°è¨­å®š
```env
# Garmin Connect èªè¨¼æƒ…å ±
GARMIN_EMAIL=your-garmin-email@example.com
GARMIN_PASSWORD=your-secure-password

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
GARMIN_CACHE_DIR=~/.cache/mindbridge/garmin
GARMIN_CACHE_HOURS=24

# ãƒ†ã‚¹ãƒˆãƒ»é–‹ç™ºç”¨
MOCK_GARMIN_ENABLED=false  # æœ¬ç•ª: false, é–‹ç™º: true
```

### å¿…è¦ãªä¾å­˜é–¢ä¿‚
```toml
# pyproject.toml
[dependencies]
garminconnect = "^0.2.17"    # Garmin Connect API
aiofiles = "^23.2.0"         # éåŒæœŸãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
structlog = "^23.2.0"        # ãƒ­ã‚°å‡ºåŠ›
tenacity = "^8.2.3"          # ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬çš„ãªå¥åº·ãƒ‡ãƒ¼ã‚¿å–å¾—
```python
from src.garmin.client import GarminClient
from src.config.settings import Settings

settings = Settings()
garmin_client = GarminClient(
    email=settings.garmin_email,
    password=settings.garmin_password
)

# ä»Šæ—¥ã®ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—
health_data = await garmin_client.get_health_data(date.today())
print(f"æ­©æ•°: {health_data.steps.total_steps}")
print(f"ç¡çœ æ™‚é–“: {health_data.sleep.total_sleep_hours}æ™‚é–“")
```

### Discord çµŒç”±ã§ã®å¥åº·ãƒ‡ãƒ¼ã‚¿ç¢ºèª
```
/health_stats today      # ä»Šæ—¥ã®å¥åº·çµ±è¨ˆ
/health_trends week      # é€±é–“ãƒˆãƒ¬ãƒ³ãƒ‰
/garmin_sync            # æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿åŒæœŸ
/health_report monthly  # æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
```

## ãƒ‡ãƒ¼ã‚¿ä¿å­˜å½¢å¼

### Obsidian ãƒãƒ¼ãƒˆä¾‹
```markdown
---
date: 2024-01-15
type: health_daily
source: garmin_connect
tags: [health, fitness, sleep, steps]
sleep_score: 85
steps_goal_achieved: true
---

# å¥åº·ãƒ‡ãƒ¼ã‚¿ - 2024-01-15

## ç¡çœ 
- **åˆè¨ˆç¡çœ æ™‚é–“**: 7 æ™‚é–“ 45 åˆ†
- **æ·±ã„ç¡çœ **: 1 æ™‚é–“ 20 åˆ†
- **ãƒ¬ãƒ ç¡çœ **: 1 æ™‚é–“ 30 åˆ†
- **ç¡çœ ã‚¹ã‚³ã‚¢**: 85/100

## æ´»å‹•é‡
- **æ­©æ•°**: 12,450 æ­© (ç›®æ¨™é”æˆ! ğŸ¯)
- **è·é›¢**: 8.2km
- **æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼**: 2,340kcal

## å¿ƒæ‹æ•°
- **å®‰é™æ™‚å¿ƒæ‹æ•°**: 58bpm
- **æœ€å¤§å¿ƒæ‹æ•°**: 165bpm

## ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
- ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°: 30 åˆ†, 5km
- ç­‹ãƒˆãƒ¬: 45 åˆ†

## AI åˆ†æ
ä»Šæ—¥ã¯ç¡çœ ã®è³ªãŒè‰¯å¥½ã§ã€é‹å‹•ç›®æ¨™ã‚‚é”æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ç¶™ç¶šçš„ãªé‹å‹•ç¿’æ…£ãŒå¿ƒæ‹æ•°ã®æ”¹å–„ã«ã¤ãªãŒã£ã¦ã„ã¾ã™ã€‚
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. èªè¨¼ã‚¨ãƒ©ãƒ¼
```
GarminAuthenticationError: Invalid credentials
```
**è§£æ±ºç­–:**
- Garmin Connect ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèª
- 2 æ®µéšèªè¨¼ãŒæœ‰åŠ¹ãªå ´åˆã¯ã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨

#### 2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™
```
GarminRateLimitError: API rate limit exceeded
```
**è§£æ±ºç­–:**
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚é–“ã‚’å»¶é•· (`GARMIN_CACHE_HOURS=48`)
- å–å¾—é »åº¦ã‚’èª¿æ•´

#### 3. ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—
```
GarminDataRetrievalError: Failed to retrieve sleep data
```
**è§£æ±ºç­–:**
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª
- Garmin Connect ã‚µãƒ¼ãƒãƒ¼çŠ¶æ³ã‚’ç¢ºèª
- ãƒªãƒˆãƒ©ã‚¤å¾Œã‚‚ã‚¨ãƒ©ãƒ¼ãŒç¶šãå ´åˆã¯ä¸€æ™‚çš„ã«ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨

### ãƒ‡ãƒãƒƒã‚°æƒ…å ±
```python
# æ¥ç¶šãƒ†ã‚¹ãƒˆ
result = await garmin_client.test_connection()
print(f"æ¥ç¶šçŠ¶æ…‹: {result['status']}")

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆ
stats = garmin_client.get_cache_stats()
print(f"ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡: {stats.hit_rate}%")
```

## é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆ

### ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨
```env
MOCK_GARMIN_ENABLED=true  # é–‹ç™ºæ™‚ã®ã¿
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
# Garmin çµ±åˆãƒ†ã‚¹ãƒˆ
uv run python test_garmin_integration.py

# ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ†ã‚¹ãƒˆ
uv run python test_health_analysis.py
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- Garmin èªè¨¼æƒ…å ±ã¯ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
- Google Secret Manager é€£æºå¯¾å¿œ
- ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æš—å·åŒ–
- API ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ

## ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

- [ ] Apple HealthKit é€£æº
- [ ] Fitbit API å¯¾å¿œ
- [ ] ãƒ˜ãƒ«ã‚¹ãƒ‡ãƒ¼ã‚¿ã®æ©Ÿæ¢°å­¦ç¿’åˆ†æ
- [ ] å¥åº·ç›®æ¨™ã®è‡ªå‹•è¨­å®šãƒ»è¿½è·¡
- [ ] åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
