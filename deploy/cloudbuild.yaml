# Google Cloud Build 設定 (Artifact Registry / 無料枠最適化)
steps:
  # Artifact Registry API とリポジトリを準備
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Prepare Artifact Registry'
    entrypoint: 'bash'
    args:
      - -c
      - |
        set -euo pipefail
        gcloud services enable artifactregistry.googleapis.com
        # 既存チェック → なければ作成
        if ! gcloud artifacts repositories describe mindbridge \
          --location=us-central1 >/dev/null 2>&1; then
          gcloud artifacts repositories create mindbridge \
            --repository-format=docker \
            --location=us-central1 \
            --description="MindBridge container images"
        fi
        gcloud auth configure-docker us-central1-docker.pkg.dev -q

  # Docker イメージをビルド（ Cloud Run 用 Dockerfile 使用）
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-f', 'Dockerfile.cloudrun',
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/mindbridge/mindbridge:${_IMAGE_TAG}',
      '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/mindbridge/mindbridge:latest',
      '.'
    ]

  # イメージを Artifact Registry にプッシュ
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/mindbridge/mindbridge:${_IMAGE_TAG}']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/mindbridge/mindbridge:latest']

# ビルドタイムアウト: 無料枠内で完了
timeout: '600s'  # 10 分

# ビルドオプション: 無料枠最適化
options:
  machineType: 'E2_MEDIUM'       # 最小構成で無料枠を活用
  diskSizeGb: '10'
  logging: 'CLOUD_LOGGING_ONLY'

substitutions:
  _IMAGE_TAG: latest
